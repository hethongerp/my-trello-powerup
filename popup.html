<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    textarea { width: 100%; height: 80px; margin-bottom: 10px; }
    button { padding: 6px 12px; background: #0052cc; color: white; border: none; cursor: pointer; }
    #attachments img { max-width: 100px; margin: 5px; }
    #attachments a { display: block; margin: 5px; }
  </style>
</head>
<body>
  <h3 id="title"></h3>
  <textarea id="note" rows="4" placeholder="Nhập nội dung chi tiết..."></textarea>
  <input type="file" id="file-upload" accept="image/*,.pdf" multiple>
  <div id="attachments"></div>
  <button id="save">💾 Lưu lại</button>

  <script>
    const t = window.TrelloPowerUp.iframe();
    const args = t.arg('itemId', 'itemName');

    document.getElementById('title').innerText = '✏️ ' + args.itemName;

    async function loadData() {
      try {
        const data = await t.get('card', 'shared', 'checklist-data') || {};
        const itemData = data[args.itemId] || { note: '', attachments: [] };
        document.getElementById('note').value = itemData.note || '';

        const attachmentsEl = document.getElementById('attachments');
        attachmentsEl.innerHTML = '';
        if (itemData.attachments) {
          itemData.attachments.forEach(url => {
            if (url.endsWith('.pdf')) {
              const link = document.createElement('a');
              link.href = url;
              link.innerText = 'Xem PDF';
              link.target = '_blank';
              attachmentsEl.appendChild(link);
            } else {
              const img = document.createElement('img');
              img.src = url;
              attachmentsEl.appendChild(img);
            }
          });
        }
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    document.getElementById('save').onclick = async () => {
      try {
        const note = document.getElementById('note').value;
        const files = document.getElementById('file-upload').files;
        const data = await t.get('card', 'shared', 'checklist-data') || {};
        const itemData = data[args.itemId] || { note: '', attachments: [], itemName: args.itemName };

        // Upload files
        for (const file of files) {
          const formData = new FormData();
          formData.append('file', file);
          const response = await fetch(`https://api.trello.com/1/cards/${t.getContext().card}/attachments?key=${t.getContext().apiKey}&token=${t.getContext().token}`, {
            method: 'POST',
            body: formData
          });
          if (!response.ok) throw new Error('Upload failed');
          const result = await response.json();
          itemData.attachments.push(result.url);
        }

        itemData.note = note;
        data[args.itemId] = itemData;
        await t.set('card', 'shared', 'checklist-data', data);
        t.notifyParent('update'); // Refresh UI
        t.closePopup();
      } catch (error) {
        console.error('Error saving data:', error);
        alert('Lỗi khi lưu, vui lòng thử lại!');
      }
    };

    loadData();
  </script>
</body>
</html>
